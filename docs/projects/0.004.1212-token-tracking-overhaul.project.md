# Token Tracking & Dashboard Overhaul

**Project ID:** 0.004.1212-token-tracking-overhaul
**Status:** In Progress (Phase 1)
**Priority:** P0
**Created:** 2025-12-12
**Owner:** Claude + Local Models

---

## Executive Summary

Overhaul the token tracking system to use **actual data** instead of estimates, enabling meaningful continuous improvement tracking.

**Key Metrics:**
- Replace estimated tokens (chars/4) with actual API data
- Track token usage by work phase for optimization
- Provide 7-day and 30-day trend visibility
- Identify optimization opportunities automatically

---

## Background & Context

### Problem Statement

Current token tracking is broken and useless:
- Hooks silently fail - `firingCount: 0` in hook-activity.json
- All tracking uses estimated tokens (chars/4) - wildly inaccurate
- Dashboard shows "0/30,000" at session start - meaningless
- No historical aggregation across sessions

### Key Discovery

Claude Code already tracks **ACTUAL** token usage in `~/.claude/stats-cache.json`:

```json
{
  "dailyModelTokens": [
    { "date": "2025-12-11", "tokensByModel": { "claude-opus-4-5-20251101": 368631 }}
  ],
  "modelUsage": {
    "claude-opus-4-5-20251101": {
      "inputTokens": 751003,
      "outputTokens": 2012254,
      "cacheReadInputTokens": 688003479,
      "cacheCreationInputTokens": 36659740
    }
  }
}
```

**We've been reinventing the wheel with inaccurate estimates.**

### Critical File Locations

- Actual token data: `~/.claude/stats-cache.json` (USER level, read-only)
- Current hooks: `.claude/hooks/budget-check.cjs`, `.claude/hooks/metrics-collector.cjs`
- Dashboard generator: `scripts/generate-dashboard.cjs`
- Hook activity log: `.claude/metrics/hook-activity.json`

---

## Solution Architecture

### Data Flow

```
┌─────────────────────────────────────────────────────────────┐
│ Claude Code Runtime                                         │
├─────────────────────────────────────────────────────────────┤
│ ~/.claude/stats-cache.json (ACTUAL daily totals by model)   │
└──────────────────────────┬──────────────────────────────────┘
                           │ read on session start/end
                           ▼
┌─────────────────────────────────────────────────────────────┐
│ Project: .claude/data/token-history.json                    │
│ - Archives per-project session summaries                    │
│ - Stores actual tokens (from stats-cache diff)              │
│ - Phase attribution (from PostToolUse hooks)                │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│ Dashboard: .claude/DASHBOARD.md                             │
│ - Shows 7-day and 30-day trends                             │
│ - Phase breakdown for optimization                          │
│ - Input/Output token split for cost awareness               │
└─────────────────────────────────────────────────────────────┘
```

### Work Phases (for Attribution)

| Phase | Tools | Optimization Target |
|-------|-------|---------------------|
| Exploration | Grep, Glob, Read (initial) | Use indexes first, scan before drill |
| Planning | Task(Plan), EnterPlanMode | Batch questions, clear context |
| Execution | Write, Edit | Delegate to local models |
| Testing | Bash(test/build) | Smart test runner, skip on pass |
| Git | Bash(git) | Minimal - low optimization potential |

---

## Implementation Phases

### Phase 1: Session Snapshot System (4 tasks)
**Goal:** Capture actual token baseline at session start
**Status:** Not Started

| ID | Description | Model | Files |
|----|-------------|-------|-------|
| T-TOKEN-001 | Create session snapshot schema | qwen | NEW: `.claude/.session-start-snapshot.json` |
| T-TOKEN-002 | Update budget-check.cjs to read stats-cache.json | deepseek | `.claude/hooks/budget-check.cjs` |
| T-TOKEN-003 | Store baseline tokens on session start | deepseek | `.claude/hooks/budget-check.cjs` |
| T-TOKEN-004 | Add diagnostic logging to budget-check | qwen | `.claude/hooks/budget-check.cjs` |

### Phase 2: Phase Attribution (4 tasks)
**Goal:** Track tool usage by work phase (not token estimates)
**Status:** Not Started

| ID | Description | Model | Files |
|----|-------------|-------|-------|
| T-TOKEN-005 | Create phase detection logic | deepseek | NEW: `.claude/hooks/phase-detector.cjs` |
| T-TOKEN-006 | Replace token estimates with phase logging | deepseek | `.claude/hooks/metrics-collector.cjs` |
| T-TOKEN-007 | Create session phases schema | qwen | NEW: `.claude/.session-phases.json` |
| T-TOKEN-008 | Add diagnostic logging to metrics-collector | qwen | `.claude/hooks/metrics-collector.cjs` |

### Phase 3: Session Finalization (4 tasks)
**Goal:** Archive actual tokens to project-level history
**Status:** Not Started

| ID | Description | Model | Files |
|----|-------------|-------|-------|
| T-TOKEN-009 | Create token history schema | qwen | NEW: `.claude/data/token-history.json` |
| T-TOKEN-010 | Create finalize-session.cjs script | deepseek | NEW: `scripts/finalize-session.cjs` |
| T-TOKEN-011 | Diff stats-cache vs snapshot for actual usage | deepseek | `scripts/finalize-session.cjs` |
| T-TOKEN-012 | Merge phase attribution with actual tokens | deepseek | `scripts/finalize-session.cjs` |

### Phase 4: Dashboard Redesign (5 tasks)
**Goal:** Show actionable trends with actual data
**Status:** Not Started

| ID | Description | Model | Files |
|----|-------------|-------|-------|
| T-TOKEN-013 | Remove current session section from dashboard | deepseek | `scripts/generate-dashboard.cjs` |
| T-TOKEN-014 | Add 7-day/30-day trend section | deepseek | `scripts/generate-dashboard.cjs` |
| T-TOKEN-015 | Add input/output cost breakdown | deepseek | `scripts/generate-dashboard.cjs` |
| T-TOKEN-016 | Add phase attribution breakdown | deepseek | `scripts/generate-dashboard.cjs` |
| T-TOKEN-017 | Add optimization recommendations | qwen | `scripts/generate-dashboard.cjs` |

---

## Data Schemas

### Session Start Snapshot
```json
{
  "capturedAt": "2025-12-12T15:00:00Z",
  "project": "Claude-Poker-Tracker",
  "baseline": {
    "dailyTokens": { "claude-opus-4-5": 100000 },
    "totalInput": 500000,
    "totalOutput": 1500000
  }
}
```

### Session Phases Log
```json
{
  "sessionId": "2025-12-12-abc123",
  "toolCalls": [
    { "timestamp": "...", "tool": "Grep", "phase": "exploration" },
    { "timestamp": "...", "tool": "Edit", "phase": "execution" }
  ],
  "phaseSummary": {
    "exploration": { "count": 45, "percent": 42 },
    "execution": { "count": 33, "percent": 31 }
  }
}
```

### Token History (Project Level)
```json
{
  "version": "1.0.0",
  "sessions": [
    {
      "date": "2025-12-12",
      "actualTokens": 85000,
      "inputTokens": 25000,
      "outputTokens": 60000,
      "phases": { "exploration": 42, "execution": 31 },
      "duration": 3600000
    }
  ],
  "aggregates": {
    "last7Days": { "totalTokens": 450000, "avgPerSession": 64000 },
    "last30Days": { "totalTokens": 1800000, "avgPerSession": 72000 }
  }
}
```

---

## Expected Dashboard Output

```markdown
## Token Usage (Last 7 Days - ACTUAL)

| Metric          | This Week | Last Week | Trend |
|-----------------|-----------|-----------|-------|
| Total tokens    | 450K      | 620K      | ↓27%  |
| Sessions        | 7         | 9         | ↓22%  |
| Avg/session     | 64K       | 69K       | ↓7%   |
| Output ratio    | 71%       | 68%       | ↑3%   |

### Cost Breakdown
| Type           | Tokens | Est. Cost % |
|----------------|--------|-------------|
| Output         | 320K   | 78%         |
| Input          | 72K    | 17%         |
| Cache Creation | 21K    | 5%          |

### Phase Attribution
| Phase       | % of Tool Calls | Optimization |
|-------------|-----------------|--------------|
| Exploration | 42%             | Use indexes first |
| Execution   | 31%             | Delegate more |
| Planning    | 15%             | Batch questions |
| Testing     | 9%              | Smart test runner |
| Git         | 3%              | - |
```

---

## Files to Create/Modify

| File | Action | Purpose |
|------|--------|---------|
| `.claude/hooks/budget-check.cjs` | Modify | Read stats-cache, save snapshot |
| `.claude/hooks/metrics-collector.cjs` | Modify | Phase attribution only, no estimates |
| `scripts/finalize-session.cjs` | Create | Diff actual tokens, archive to project |
| `scripts/generate-dashboard.cjs` | Modify | Historical trends, phase breakdown |
| `.claude/.session-start-snapshot.json` | Create | Baseline tokens at session start |
| `.claude/.session-phases.json` | Create | Tool calls by phase |
| `.claude/data/token-history.json` | Create | Project-level session history |

---

## Risk: Silent Hook Failures

Hooks currently show `firingCount: 0`. Root cause investigation needed:
1. Add stderr logging to hooks
2. Check if stdin is connected
3. Verify PostToolUse hook data structure

**Mitigation:** Phase 1 & 2 include diagnostic logging tasks.

---

## Success Criteria

- [ ] Session start captures actual token baseline from stats-cache.json
- [ ] Phase attribution tracks tool usage (not token estimates)
- [ ] Session end archives actual tokens to project history
- [ ] Dashboard shows 7-day and 30-day trends with actual data
- [ ] Cost breakdown shows input/output split
- [ ] Phase attribution identifies optimization opportunities

---

## Sources

- [Langfuse - Token & Cost Tracking](https://langfuse.com/docs/observability/features/token-and-cost-tracking)
- [Portkey - Tracking LLM Token Usage](https://portkey.ai/blog/tracking-llm-token-usage-across-providers-teams-and-workloads/)
- [Koombea - LLM Cost Optimization Guide](https://ai.koombea.com/blog/llm-cost-optimization)
